# Privilege Escalation and Maintaining Access

* Types of privilege escalation
  - Vertical
    - The attacker is able to move from a lower privileged user to a higher privileged user. For example from a low-end user to administrator or root user.
  - Horizontal: 
    - The attacker keeps the same set or level of privileges but assumes the identity of a different user (he/she does not gain any further privilege).


---

### Maintaining Access

In this phase we will make sure that our session is :

+ Stable (does not get dropped)
  - One of the main issues when you get a meterpreter session on the target, is that the end user can kill the exploited process. It can happen, for example, when you exploit a client-side vulnerability through the web browser and the user just closes the web browser window.
+ Privileged (can run with high privileges)
+ Persistent (through reboots)




---

* Stable

Our goal of making our session stable. To let Metasploit automatically migrate to another process, you can use the following command (on windows machine):

> run post/windows/manage/migrate

---

* Windows Privilege Escalation

The easiest and fastest way to get higher privileges is by running getsystem within meterpreter.It will automatically find the best technique to elevate privileges.

![image](https://user-images.githubusercontent.com/73122852/234651603-834739f8-11fb-4bd1-a4ed-9baf2b8ada39.png)


Notice that depending on the current privileges on the machine, the getsystem command may fail. For example, if you use this technique on systems with User Account Control (UAC) enabled (Windows Vista+), it will not work as well as systems like Windows XP.

When UAC is enabled on the remote system, bypassuac is one of the modules we can use to bypass it.

First of all, we can verify if UAC is enabled by running the module post/windows/gather/win_privs.

If in the result the UAC Enabled column is set to true, it means that the remote system has the UAC enabled.


* Bypass UAC Protection

> use exploit/windows/local/bypassuac_injection


---

* Flow

1- After meterpreter get some system information

> sysinfo

![image](https://user-images.githubusercontent.com/73122852/235372168-53582c37-8b80-4240-afeb-af413c34b472.png)

2-Then run the easiest way to get higher privileges in windows

> getsystem

![image](https://user-images.githubusercontent.com/73122852/235372353-c5c5950e-3bf4-45ff-954e-72c20af83bde.png)

it seems to not be working that maybe because the "User Account Control" Feature is enabled on the remote system

3- list the current session privileges

> getprivs

![image](https://user-images.githubusercontent.com/73122852/235372489-f2962ea2-3ee2-4435-b790-b7833e6a3814.png)

Although it returns some privileges , these are not enough to elevate our session.
Moreover, to get a better view of the current session , run post exploitation

> run post/windows/gather/win_privs

![image](https://user-images.githubusercontent.com/73122852/235372928-7a7e4004-b09b-4182-b259-1133244d7f7f.png)

As you see The "UAC" is enabled, metasploit provides some modules to bypass the UAC protection

> use exploit/windows/local/bypassuac_injection

Then set the session , set the target (windows (x86 or x64)) , set payload (windows/x64/meterpreter/reverse_tcp) and exploit

Now if you run getprivs , you can see many more privileges.


---

* Linux Privilege Escalation

Get some information about the system

> sysinfo

Get target OS 

> getuid

Then you can search for a exploit for the current version















