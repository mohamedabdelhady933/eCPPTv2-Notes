# Exploitation

Metasploit is an exploitation framework that makes it very easy to access a library of exploits created by the community, in order to running them against vulnerable
targets.


* Windows Authentication Weaknesses

The authentication protocol used between Windows clients and servers is called [NTLM](https://msdn.microsoft.com/en-us/library/windows/desktop/aa378749(v=vs.85).aspx)  (NT LAN Manager). Although NTLM has been replaced by Kerberos, it is still
widely used and supported in Windows machines. For example, it is used either when the client is authenticating to a server using an IP address or, when the client is
authenticating to a server that does not belong to the same domain.

---

* NTLM

NTLM authentication is a challenge/response protocol and consists of three messages: Type 1 (negotiation), Type 2 (challenge) and Type 3 (authentication). The very first scheme was LM, which turned out to be very simple and easy to crack. As a result, it was replaced by NTLM, which in turn was deprecated by NTLMv2 and finally Kerberos at the end.

---

* How challenge/response works

1- The client sends the Type 1 message, which contains the username (in plaintext)

2- The server generates the challenge and sends it back to the client

3- The client encrypts the challenge with the hash of the user password and returns the results of the computation to the server

![image](https://user-images.githubusercontent.com/73122852/232254349-807cf567-d443-4e05-9332-b5c61f9b5f36.png)

---

* The algorithm used to compute the LM Hash is DES and here are the steps used by Windows to do so:

  + Password is transformed to upper case
  + Add null chars until it is 14-bytes long
  + Split the password in two blocks (7 bytes chunks plus a byte of parity)
  + Each of the two keys is used to encrypt the fixed string ‘KGS!@#3$%” (8-byte ciphertext)
  + The two ciphertext are concatenated to form a 16-byte value


---

* NTLM v1 attack

The goal of our attack is to gain the password hash through the implementation of this protocol.The first item we need to address in this exploitation
process, is to create a listening SMB service that will both accept incoming connections and send back a fixed challenge. As you can imagine, we use a fixed challenge to help us in decrypting the response.One of the easiest ways to force the initiation of the NTLM protocol is through SMB authentication.


![image](https://user-images.githubusercontent.com/73122852/232258329-31809542-0f36-49d5-a74f-3b38762458c0.png)

Once the metasploit listener is set up , we can move on the next step

![image](https://user-images.githubusercontent.com/73122852/232258383-f8f5396b-b317-4cae-865f-6a8521556b3b.png)

One of the easiest ways to force the initiation of the NTLM protocol is through SMB authentication.


![image](https://user-images.githubusercontent.com/73122852/232258424-1ff0b22c-1f70-4536-9786-ead9830fbf19.png)

When someone opens the page with the previous html tag that attempts a connection to our listener.

![image](https://user-images.githubusercontent.com/73122852/232258483-90a5f426-8d35-400e-8291-d0efc51f4175.png)


Also notice that every time the client connects to us, the hash remains the same (challenge is fixed). This demonstrates that the protocol’s randomness is defeated using the crafted challenge 1122334455667788 .


**Note:-**

It is very useful to know that when the password length is less than or equal to seven characters (i.e. 1235467), the last 8 bytes of the NTLM response are always the same: 2f85252cc731bb25.


Now that we have the hashes, we can start cracking them. We can do this in different ways and with different tools (online and offline).

> john --format=ntlm hashs.txt

* rcracki_mt  Tool

To quicken the cracking process we can use [rainbow tables](http://project-rainbowcrack.com/table.htm) together with [rcracki_mt](https://github.com/foreni-packages/rcracki_mt) (an edited version of rerack).

Once we have downloaded the correct tables and the tool,we can now copy the first 8-bytes of the LMHASH response and use them to start the cracking process.

> rcracki_mt -h 1f548398f0f49ea1 -t 4 *.rti

![image](https://user-images.githubusercontent.com/73122852/232259381-cd447eec-15b4-475a-8919-2b75f8a898e7.png)

What we can do now is brute-force the remainder of the hash. Metasploit, once again, comes to the rescue. In the metasploit-framework/tools/password folder,
there is a ruby script named halflm_second.rb that does exactly what we need.

> ruby half_second.rb -n  1£548398£0f49eal8e2f0dcb9562b75caa32e75aebf1d694c  -p ELSPWD1 (The password of the first part)


Although, we cracked the entire password, we can see that it is all in uppercase, which may not be accurate (ELSPWD123). The next step is to find the case-sensitive password. To do this we can use a Perl script contained in the john folder: netnt1m.pl.

> perl netntlm.pl -file hash-passwords.txt --seed ELSPWD123


![image](https://user-images.githubusercontent.com/73122852/232331488-935ce2bf-bf44-4344-b942-fbb77786ddb3.png)


* NTLM v2

The main difference with the old NTLMv1 is that the type 3 message is generated in a different way. 

![image](https://user-images.githubusercontent.com/73122852/232333286-451d3bfd-54f7-4301-a107-186f819f0c33.png)


**Under the security perspective, NTLMv2 changes are as follows:**

+ Due to timestamp and the client response, the response changes every time.

+ Impossible to create rainbow tables to gather the NT hash or the password from the NTLMv2 response.

+ Dictionary does not make sense as the key is a hash.

+ The only possible attack is by brute-forcing the HMAC key

+ The NTLMv2 hash is bound to a particular server and particular username so it's not reusable.



* Capture LM NTLM 

1- Start metasploit and use auxiliary/server/capture/smb

> use auxiliary/server/capture/smb

2- Set Options then run

> set JOHNPWFILE hashs    (to set the hashs output file)

> run





















